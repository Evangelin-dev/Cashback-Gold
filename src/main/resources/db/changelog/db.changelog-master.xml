<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- Temporary OTP Table -->
    <changeSet id="1" author="azeem">
        <createTable tableName="otp_verification">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="otp" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="verified" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <!-- Users Table -->
    <changeSet id="2" author="azeem">
        <createTable tableName="users">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="full_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="gender" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="dob" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="mobile" type="VARCHAR(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="country_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="city" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="town" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="state" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="country" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- Add role constraint -->
    <changeSet id="3" author="cseazeem">
        <sql>
            ALTER TABLE users ADD CONSTRAINT chk_user_role
                CHECK (role IN ('ADMIN', 'PARTNER', 'B2B', 'USER'));
        </sql>
    </changeSet>

    <!-- Add status constraint -->
    <changeSet id="3-1" author="cseazeem">
        <sql>
            ALTER TABLE users ADD CONSTRAINT chk_user_status
                CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED'));
        </sql>
    </changeSet>

    <!-- KYC Documents Table -->
    <changeSet id="3-2" author="azeem">
        <createTable tableName="kyc_documents">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_kyc_user" references="users(id)"/>
            </column>
            <column name="user_type" type="VARCHAR(20)"/>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="aadhar_url" type="TEXT"/>
            <column name="gst_certificate_url" type="TEXT"/>
            <column name="pan_card_url" type="TEXT"/>
            <column name="address_proof_url" type="TEXT"/>
            <column name="bank_statement_url" type="TEXT"/>
            <column name="submitted_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- Add status constraint for kyc_documents -->
    <changeSet id="3-3" author="azeem">
        <sql>
            ALTER TABLE kyc_documents ADD CONSTRAINT chk_kyc_status
                CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED'));
        </sql>
    </changeSet>

    <!-- Add indexes for performance -->
    <changeSet id="3-4" author="azeem">
        <createIndex tableName="users" indexName="idx_users_email">
            <column name="email"/>
        </createIndex>
        <createIndex tableName="users" indexName="idx_users_mobile">
            <column name="mobile"/>
        </createIndex>
        <createIndex tableName="kyc_documents" indexName="idx_kyc_user_id">
            <column name="user_id"/>
        </createIndex>
        <createIndex tableName="kyc_documents" indexName="idx_kyc_user_type">
            <column name="user_type"/>
        </createIndex>
    </changeSet>

    <!-- Insert Admin User -->
    <changeSet id="4" author="azeem">
        <insert tableName="users">
            <column name="full_name" value="Admin User"/>
            <column name="gender" value="male"/>
            <column name="dob" value="1990-01-01"/>
            <column name="email" value="cseazeem@gmail.com"/>
            <column name="mobile" value="+918601533220"/>
            <column name="country_code" value="+91"/>
            <column name="city" value="Admin City"/>
            <column name="town" value="Admin Town"/>
            <column name="state" value="Admin State"/>
            <column name="country" value="Admin Country"/>
            <column name="password" value="$2a$10$2FW0Fob1PaYrgoR6h0/8EeTmVr.fgMI4n04Pqba7crwFPSFb.Kgzm"/>
            <column name="role" value="ADMIN"/>
            <column name="status" value="APPROVED"/>
            <column name="created_at" valueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" valueComputed="CURRENT_TIMESTAMP"/>
        </insert>
    </changeSet>

    <changeSet id="5" author="azeem">
        <createTable tableName="ornaments">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="gold_per_gram_price" type="DECIMAL(10,2)">
                <constraints nullable="true"/>
            </column>
            <column name="category" type="VARCHAR(100)"/>
            <column name="sub_category" type="VARCHAR(100)"/>
            <column name="item_type" type="VARCHAR(100)"/>
            <column name="details" type="TEXT"/>
            <column name="description" type="TEXT"/>
            <column name="description1" type="TEXT"/>
            <column name="description2" type="TEXT"/>
            <column name="description3" type="TEXT"/>
            <column name="material" type="VARCHAR(100)"/>
            <column name="purity" type="VARCHAR(100)"/>
            <column name="quality" type="VARCHAR(100)"/>
            <column name="warranty" type="VARCHAR(100)"/>
            <column name="origin" type="VARCHAR(20)" defaultValue="INDIAN">
                <constraints nullable="false"/>
            </column>
            <column name="making_charge_percent" type="DECIMAL(5,2)">
                <constraints nullable="false"/>
            </column>
            <column name="gross_weight" type="DECIMAL(10,2)"/>
            <column name="discount" type="DECIMAL(10,2)"/>
            <column name="total_price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="total_price_after_discount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="main_image" type="TEXT"/>
            <column name="sub_images" type="TEXT[]"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="5-1" author="azeem">
        <createTable tableName="price_breakups">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ornament_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_price_breakup_ornament" references="ornaments(id)"/>
            </column>
            <column name="component" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="net_weight" type="DECIMAL(10,2)"/>
            <column name="value" type="DECIMAL(10,2)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>


    <changeSet id="7" author="azeem">
        <createTable tableName="marketing_resources">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="file_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="file_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="file_url" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="upload_date" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="download_count" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="7-1" author="azeem">
        <sql>
            ALTER TABLE marketing_resources ADD CONSTRAINT chk_marketing_resources_status
                CHECK (status IN ('ACTIVE','INACTIVE'));
        </sql>
    </changeSet>

    <changeSet id="8" author="azeem">
        <createTable tableName="sip_plans">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" />
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="tenure" type="VARCHAR(100)"/>
            <column name="monthly_amount" type="VARCHAR(100)"/>
            <column name="description" type="TEXT"/>
            <column name="status" type="VARCHAR(50)"/>
        </createTable>
    </changeSet>

    <changeSet id="8-1" author="azeem">
        <sql>
            ALTER TABLE sip_plans ADD CONSTRAINT chk_sip_plans_status
                CHECK (status IN ('ACTIVE','CLOSED'));
        </sql>
    </changeSet>

    <changeSet id="8-2" author="azeem">
        <addColumn tableName="sip_plans">
            <column name="key_point1" type="VARCHAR(255)"/>
            <column name="key_point2" type="VARCHAR(255)"/>
            <column name="key_point3" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="9" author="azeem">
        <createTable tableName="saving_plans">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="duration" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="9-1" author="azeem">
        <sql>
            ALTER TABLE saving_plans ADD CONSTRAINT chk_saving_plans_status
                CHECK (status IN ('ACTIVE','CLOSED'));
        </sql>
    </changeSet>

    <changeSet id="9-2" author="azeem">
        <addColumn tableName="saving_plans">
            <column name="key_point1" type="VARCHAR(255)"/>
            <column name="key_point2" type="VARCHAR(255)"/>
            <column name="key_point3" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="10" author="azeem">
        <createTable tableName="gold_plant_schemes">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="duration" type="VARCHAR(100)"/>
            <column name="min_invest" type="VARCHAR(100)"/>
            <column name="status" type="VARCHAR(50)"/>
            <column name="description" type="TEXT"/>

        </createTable>
    </changeSet>

    <changeSet id="10-1" author="azeem">
        <sql>
            ALTER TABLE gold_plant_schemes ADD CONSTRAINT chk_gold_plant_schemes_status
                CHECK (status IN ('ACTIVE','CLOSED'));
        </sql>
    </changeSet>

    <changeSet id="10-2" author="azeem">
        <addColumn tableName="gold_plant_schemes">
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </addColumn>
    </changeSet>

    <changeSet id="10-3" author="azeem">
        <addColumn tableName="gold_plant_schemes">
            <column name="key_point1" type="VARCHAR(255)"/>
            <column name="key_point2" type="VARCHAR(255)"/>
            <column name="key_point3" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="11" author="azeem">
        <createTable tableName="campaigns">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
            <column name="start_date" type="DATE"/>
            <column name="end_date" type="DATE"/>
            <column name="multiplier" type="VARCHAR(50)"/>
            <column name="status" type="VARCHAR(50)"/>
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="11-1" author="azeem">
        <sql>
            ALTER TABLE campaigns ADD CONSTRAINT chk_campaigns_status
                CHECK (status IN ('ACTIVE','INACTIVE','SCHEDULED'));
        </sql>
    </changeSet>

    <changeSet id="12" author="azeem">
        <createTable tableName="bank_accounts">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="bank" type="VARCHAR(255)"/>
            <column name="account" type="VARCHAR(255)"/>
            <column name="ifsc" type="VARCHAR(255)"/>
            <column name="status" type="VARCHAR(50)"/>
            <column name="description" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="12-1" author="azeem">
        <sql>
            ALTER TABLE bank_accounts ADD CONSTRAINT chk_bank_accounts_status
                CHECK (status IN ('ACTIVE','INACTIVE'));
        </sql>
    </changeSet>

    <changeSet id="12-2" author="azeem">
        <addColumn tableName="bank_accounts">
            <column name="upi_id" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>


    <changeSet id="13" author="azeem">
        <createTable tableName="faqs">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="question" type="TEXT"/>
            <column name="answer" type="TEXT"/>
            <column name="type" type="VARCHAR(50)"/>
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="13-1" author="azeem">
        <sql>
            ALTER TABLE faqs ADD CONSTRAINT chk_faqs_type
                CHECK (type IN ('HOME', 'CHIT', 'SIP', 'SCHEME'));
        </sql>
    </changeSet>


    <!-- B2B Profiles Table -->
    <changeSet id="14" author="azeem">
        <createTable tableName="b2b_profiles">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" unique="true" foreignKeyName="fk_b2b_user" references="users(id)"/>
            </column>
            <column name="company_name" type="VARCHAR(255)"/>
            <column name="gstin" type="VARCHAR(15)"/>
            <column name="pan" type="VARCHAR(10)"/>
            <column name="address" type="TEXT"/>
            <column name="bank_account" type="VARCHAR(100)"/>
            <column name="upi" type="VARCHAR(100)"/>
            <column name="team_email" type="VARCHAR(255)"/>
            <column name="gst_certificate_url" type="TEXT"/>
            <column name="pan_card_url" type="TEXT"/>
            <column name="address_proof_url" type="TEXT"/>
            <column name="bank_statement_url" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <!-- Wallets Table -->
    <changeSet id="15" author="azeem">
        <createTable tableName="wallets">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="balance" type="DECIMAL(15,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="credit_limit" type="DECIMAL(15,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="used_credit" type="DECIMAL(15,2)" defaultValue="0.00">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint
                constraintName="fk_wallet_user"
                baseTableName="wallets"
                baseColumnNames="user_id"
                referencedTableName="users"
                referencedColumnNames="id"/>
    </changeSet>

    <!-- Wallet Transactions Table -->
    <changeSet id="16" author="azeem">
        <createTable tableName="wallet_transactions">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="wallet_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(15,2)">
                <constraints nullable="false"/>
            </column>
            <column name="payment_method" type="VARCHAR(50)"/>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint
                constraintName="fk_transaction_wallet"
                baseTableName="wallet_transactions"
                baseColumnNames="wallet_id"
                referencedTableName="wallets"
                referencedColumnNames="id"/>
    </changeSet>

    <!-- Add constraints for wallet_transactions -->
    <changeSet id="17" author="azeem">
        <sql>
            ALTER TABLE wallet_transactions ADD CONSTRAINT chk_transaction_type
                CHECK (type IN ('TOPUP', 'PURCHASE'));
            ALTER TABLE wallet_transactions ADD CONSTRAINT chk_transaction_status
                CHECK (status IN ('PENDING', 'COMPLETED', 'FAILED'));
        </sql>
    </changeSet>

    <!-- Gold Purchase Table -->
    <changeSet id="18" author="azeem">
        <createTable tableName="gold_purchase">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="rate_per_gram" type="NUMERIC(12,2)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="NUMERIC(12,2)">
                <constraints nullable="false"/>
            </column>
            <column name="delivery_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="payment_method" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="total_price" type="NUMERIC(14,2)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="19" author="cseazeem">
        <createTable tableName="gold_purchase_orders">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="customer_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="customer_type" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="price_per_gram" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="total_amount" type="DECIMAL(12,2)">
                <constraints nullable="false"/>
            </column>
            <column name="delivery_method" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="payment_method" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="19-1" author="cseazeem">
        <sql>
            ALTER TABLE gold_purchase_orders
                ADD CONSTRAINT chk_customer_type
                    CHECK (customer_type IN ('USER', 'B2B'));
        </sql>
    </changeSet>

    <changeSet id="20-2" author="cseazeem">
        <sql>
            ALTER TABLE gold_purchase_orders
                ADD CONSTRAINT chk_order_status
                    CHECK (status IN ('PENDING', 'PROCESSING', 'COMPLETED', 'CANCELLED'));
        </sql>
    </changeSet>

    <changeSet id="21" author="azeem">
        <createTable tableName="support_tickets">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT"/>
            <column name="subject" type="VARCHAR(255)"/>
            <column name="message" type="TEXT"/>
            <column name="status" type="VARCHAR(20)" defaultValue="OPEN"/>
            <column name="submitted_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <!-- Create sips table -->
    <changeSet id="22" author="cseazeem">
        <createTable tableName="sips">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_sip_user" references="users(id)"/>
            </column>
            <column name="start_date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DOUBLE PRECISION">
                <constraints nullable="false"/>
            </column>
            <column name="duration" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="plan" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="plan_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="Active">
                <constraints nullable="false"/>
            </column>
            <column name="commission" type="VARCHAR(20)" defaultValue="₹0">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="22-1" author="cseazeem">
        <addColumn tableName="sips">
            <column name="created_by" type="BIGINT"/>
        </addColumn>
    </changeSet>

    <!-- Add status constraint -->
    <changeSet id="23" author="cseazeem">
        <sql>
            ALTER TABLE sips ADD CONSTRAINT chk_sip_status
                CHECK (STATUS IN ('ACTIVE', 'CANCELLED', 'COMPLETED'));
        </sql>
    </changeSet>

    <changeSet id="24" author="azeem">
        <createTable tableName="flyers">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="url" type="TEXT"/>
            <column name="type" type="VARCHAR(50)"/>
            <column name="upload_date" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="24-1" author="azeem">
        <sql>
            ALTER TABLE flyers ADD CONSTRAINT chk_flyer_type
                CHECK (type IN ('GOLD_PLANT', 'SIP_PLAN', 'SAVING_PLAN'));
        </sql>
    </changeSet>

    <changeSet id="25" author="azeem">
        <createTable tableName="inventory">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="total_stock" type="DOUBLE PRECISION"/>
            <column name="in_store_stock" type="DOUBLE PRECISION"/>
            <column name="gold_stock" type="DOUBLE PRECISION"/>
            <column name="silver_stock" type="DOUBLE PRECISION"/>
            <column name="diamond_stock" type="DOUBLE PRECISION"/>
            <column name="unit" type="VARCHAR(10)"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="25-1" author="azeem">
        <addColumn tableName="inventory">
            <column name="user_id" type="BIGINT" />
        </addColumn>

        <addForeignKeyConstraint
                baseTableName="inventory"
                baseColumnNames="user_id"
                constraintName="fk_inventory_user"
                referencedTableName="users"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="26" author="azeem">
        <createTable tableName="order_history">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="order_id" type="VARCHAR(50)"/>
            <column name="user_id" type="BIGINT"/>
            <column name="customer_name" type="VARCHAR(100)"/>
            <column name="customer_type" type="VARCHAR(20)"/>
            <column name="plan_type" type="VARCHAR(30)"/>
            <column name="plan_name" type="VARCHAR(100)"/>
            <column name="duration" type="VARCHAR(50)"/>
            <column name="amount" type="DECIMAL(12,2)"/>
            <column name="payment_method" type="VARCHAR(50)"/>
            <column name="status" type="VARCHAR(30)"/>
            <column name="created_at" type="TIMESTAMP"/>
            <column name="address" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="create-cart-items-table" author="azeem">
        <createTable tableName="cart_items">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="ornament_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="INT" defaultValueNumeric="1">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="cart_items"
                baseColumnNames="user_id"
                constraintName="fk_cart_user"
                referencedTableName="users"
                referencedColumnNames="id"
                onDelete="CASCADE"/>

        <addForeignKeyConstraint
                baseTableName="cart_items"
                baseColumnNames="ornament_id"
                constraintName="fk_cart_ornament"
                referencedTableName="ornaments"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <!-- Add referral_code and referred_by columns to users table -->
    <changeSet id="27" author="azeem">
        <addColumn tableName="users">
            <column name="referral_code" type="VARCHAR(100)">
                <constraints unique="true"/>
            </column>
            <column name="referred_by" type="BIGINT"/>
        </addColumn>

        <addForeignKeyConstraint
                baseTableName="users"
                baseColumnNames="referred_by"
                constraintName="fk_users_referred_by"
                referencedTableName="users"
                referencedColumnNames="id"
                onDelete="SET NULL"/>
    </changeSet>

    <!-- Create commissions table -->
    <changeSet id="28" author="azeem">
        <createTable tableName="commissions">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="partner_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="order_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="order_amount" type="DECIMAL(12,2)">
                <constraints nullable="false"/>
            </column>
            <column name="commission_amount" type="DECIMAL(12,2)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="Pending">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="commissions"
                baseColumnNames="partner_id"
                constraintName="fk_commission_partner"
                referencedTableName="users"
                referencedColumnNames="id"
                onDelete="CASCADE"/>

        <addForeignKeyConstraint
                baseTableName="commissions"
                baseColumnNames="user_id"
                constraintName="fk_commission_user"
                referencedTableName="users"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="28-1" author="azeem">
        <addColumn tableName="commissions">
            <column name="level" type="INT"/>
        </addColumn>
    </changeSet>


    <changeSet id="29" author="azeem">
        <createTable tableName="payout_requests">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="partner_id" type="BIGINT"/>
            <column name="amount" type="DECIMAL(12,2)"/>
            <column name="method" type="VARCHAR(50)"/>
            <column name="method_detail" type="VARCHAR(255)"/>
            <column name="status" type="VARCHAR(20)" defaultValue="Pending"/>
            <column name="requested_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="26-1" author="azeeem">
        <addColumn tableName="order_history">
            <column name="razorpay_order_id" type="varchar(255)"/>
            <column name="razorpay_payment_id" type="varchar(255)"/>
            <column name="razorpay_signature" type="varchar(512)"/>
            <column name="receipt_id" type="varchar(255)"/>
            <column name="payment_status" type="varchar(100)"/>
        </addColumn>
    </changeSet>

    <changeSet id="update-plan-name" author="azeem">
        <modifyDataType tableName="order_history" columnName="plan_name" newDataType="VARCHAR(255)"/>
        <modifyDataType tableName="order_history" columnName="receipt_id" newDataType="VARCHAR(255)"/>
    </changeSet>


    <changeSet id="26-2" author="azeem">
        <addColumn tableName="order_history">
            <column name="cgst" type="DECIMAL(10,2)"/>
            <column name="sgst" type="DECIMAL(10,2)"/>
            <column name="gst" type="DECIMAL(10,2)"/>
        </addColumn>
    </changeSet>


    <changeSet id="30" author="azeem">
        <createTable tableName="user_saving_enrollments">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="saving_plan_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="DATE"/>
            <column name="status" type="VARCHAR(20)"/> <!-- ENROLLED, TERMINATED, COMPLETED -->
            <column name="accumulated_gold_grams" type="DECIMAL(10,4)"/>
            <column name="accumulated_amount" type="DECIMAL(10,2)"/>
            <column name="total_bonus" type="DECIMAL(10,2)"/>
        </createTable>
    </changeSet>

    <changeSet id="30-1" author="azeem">
        <addColumn tableName="user_saving_enrollments">
            <column name="extra_months" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <changeSet id="31" author="azeem">
        <createTable tableName="user_saving_payments">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="enrollment_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="month" type="INT"/>
            <column name="payment_date" type="DATE"/>
            <column name="amount_paid" type="DECIMAL(10,2)"/>
            <column name="gold_grams" type="DECIMAL(10,4)"/>
            <column name="bonus_applied" type="DECIMAL(10,2)"/>
            <column name="on_time" type="BOOLEAN"/>
        </createTable>
    </changeSet>

    <changeSet id="31.1" author="azeeem">
        <addColumn tableName="user_saving_payments">
            <column name="razorpay_order_id" type="varchar(100)"/>
            <column name="razorpay_payment_id" type="varchar(100)"/>
            <column name="razorpay_signature" type="varchar(255)"/>
        </addColumn>
    </changeSet>


    <changeSet id="32" author="azeem">
        <createTable tableName="user_gold_plant_enrollments">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="gold_plant_scheme_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="amount_invested" type="DECIMAL(15,2)">
                <constraints nullable="false"/>
            </column>

            <column name="start_date" type="DATE">
                <constraints nullable="false"/>
            </column>

            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>

            <column name="gold_yield_accumulated" type="DECIMAL(15,4)" defaultValueNumeric="0.0000">
                <constraints nullable="false"/>
            </column>

            <column name="lockin_completed" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <column name="recalled" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="32-1" author="azeem">
        <addForeignKeyConstraint
                baseTableName="user_gold_plant_enrollments"
                baseColumnNames="user_id"
                referencedTableName="users"
                referencedColumnNames="id"
                constraintName="fk_gold_plant_user"/>

        <addForeignKeyConstraint
                baseTableName="user_gold_plant_enrollments"
                baseColumnNames="gold_plant_scheme_id"
                referencedTableName="gold_plant_schemes"
                referencedColumnNames="id"
                constraintName="fk_gold_plant_scheme"/>
    </changeSet>

    <changeSet id="32-2" author="azeem">
        <addColumn tableName="user_gold_plant_enrollments">
            <column name="razorpay_order_id" type="VARCHAR(100)"/>
            <column name="razorpay_payment_id" type="VARCHAR(100)"/>
            <column name="razorpay_signature" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>


    <changeSet id="33" author="azeem">
        <createTable tableName="cashback_gold_schemes">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="duration" type="VARCHAR(100)"/>
            <column name="min_invest" type="VARCHAR(100)"/>
            <column name="status" type="VARCHAR(50)"/>
            <column name="description" type="TEXT"/>
        </createTable>
    </changeSet>

    <changeSet id="33-1" author="azeem">
        <sql>
            ALTER TABLE cashback_gold_schemes ADD CONSTRAINT chk_cashback_gold_schemes_status
                CHECK (status IN ('ACTIVE','CLOSED'));
        </sql>
    </changeSet>

    <changeSet id="33-2" author="azeem">
        <addColumn tableName="cashback_gold_schemes">
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </addColumn>
    </changeSet>

    <changeSet id="33-3" author="azeem">
        <addColumn tableName="cashback_gold_schemes">
            <column name="key_point1" type="VARCHAR(255)"/>
            <column name="key_point2" type="VARCHAR(255)"/>
            <column name="key_point3" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="34" author="azeem">
        <createTable tableName="user_cashback_gold_enrollments">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="scheme_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="total_amount_paid" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="gold_accumulated" type="DECIMAL(10,4)">
                <constraints nullable="false"/>
            </column>

            <column name="activated" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <column name="recalled" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <column name="recall_type" type="VARCHAR(20)"/>

            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="34-1" author="azeem">
        <addForeignKeyConstraint
                baseTableName="user_cashback_gold_enrollments"
                baseColumnNames="user_id"
                constraintName="fk_ucge_user"
                referencedTableName="users"
                referencedColumnNames="id"/>

        <addForeignKeyConstraint
                baseTableName="user_cashback_gold_enrollments"
                baseColumnNames="scheme_id"
                constraintName="fk_ucge_scheme"
                referencedTableName="cashback_gold_schemes"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="34-2" author="azeem">
        <addColumn tableName="user_cashback_gold_enrollments">
            <column name="recall_final_amount" type="DECIMAL(10,2)"/>
        </addColumn>
    </changeSet>


    <changeSet id="35" author="azeem">
        <createTable tableName="user_cashback_gold_payments">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="enrollment_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="amount_paid" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="gold_grams" type="DECIMAL(10,4)">
                <constraints nullable="false"/>
            </column>

            <column name="payment_date" type="DATE">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="user_cashback_gold_payments"
                baseColumnNames="enrollment_id"
                constraintName="fk_cashback_gold_payment_enrollment"
                referencedTableName="user_cashback_gold_enrollments"
                referencedColumnNames="id"
                onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="35-1" author="azeem">
        <addColumn tableName="user_cashback_gold_payments">
            <column name="razorpay_order_id" type="VARCHAR(255)"/>
            <column name="razorpay_payment_id" type="VARCHAR(255)"/>
            <column name="razorpay_signature" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="36" author="azeem">
        <createTable tableName="metal_rates">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="metal_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="rate_inr_per_gram" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="fetched_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="37" author="azeem">
        <createTable tableName="metal_rate_history">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true"/>
            </column>
            <column name="metal_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="rate_inr_per_gram" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="fetched_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="38" author="azeem">
        <createTable tableName="razorpay_payment">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="razorpay_order_id" type="VARCHAR(255)"/>
            <column name="razorpay_payment_id" type="VARCHAR(255)"/>
            <column name="razorpay_signature" type="VARCHAR(255)"/>
            <column name="amount" type="NUMERIC(10,2)"/>
            <column name="payment_type" type="VARCHAR(50)"/>
            <column name="enrollment_id" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="39" author="azeem">
        <addColumn tableName="razorpay_payment">
            <column name="status" type="VARCHAR(50)"/>
        </addColumn>
    </changeSet>

    <changeSet id="40" author="azeem">
        <createTable tableName="nominees">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="full_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="relationship" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="dob" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="gender" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_nominee_user" references="users(id)"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="41" author="azeem">
        <createTable tableName="contact_messages">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(120)">
                <constraints nullable="false"/>
            </column>
            <column name="last_name" type="VARCHAR(120)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(180)">
                <constraints nullable="false"/>
            </column>
            <column name="phone" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="TEXT"/>
            <column name="status" type="VARCHAR(24)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="contact_messages" indexName="idx_contact_email">
            <column name="email"/>
        </createIndex>
        <createIndex tableName="contact_messages" indexName="idx_contact_phone">
            <column name="phone"/>
        </createIndex>
        <createIndex tableName="contact_messages" indexName="idx_contact_status">
            <column name="status"/>
        </createIndex>
    </changeSet>

    <changeSet id="42" author="azeem">
        <createTable tableName="wishlist_items">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_wishlist_user"
                             references="users(id)"/>
            </column>

            <column name="ornament_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_wishlist_ornament"
                             references="ornaments(id)"/>
            </column>

            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- A user can wish-list an ornament only once -->
        <addUniqueConstraint tableName="wishlist_items"
                             columnNames="user_id, ornament_id"
                             constraintName="uk_wishlist_user_ornament"/>

        <createIndex indexName="idx_wishlist_user" tableName="wishlist_items">
            <column name="user_id"/>
        </createIndex>
        <createIndex indexName="idx_wishlist_ornament" tableName="wishlist_items">
            <column name="ornament_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="43" author="azeeem">
        <createTable tableName="addresses">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="full_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="mobile" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="address_line1" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address_line2" type="VARCHAR(255)"/>
            <column name="city" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="state" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="postal_code" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_addresses_user"
                             referencedTableName="users" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>
